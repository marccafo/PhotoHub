using PhotoHub.API.Shared.Models;

namespace PhotoHub.API.Shared.Services;

public class MediaRecognitionService
{
    /// <summary>
    /// Detects media type tags based on EXIF metadata and file characteristics
    /// </summary>
    public async Task<List<AssetTagType>> DetectMediaTypeAsync(
        string filePath, 
        AssetExif? exif, 
        CancellationToken cancellationToken = default)
    {
        var tags = new List<AssetTagType>();
        
        if (exif == null) 
            return tags;
        
        // Detect Panorama (very wide or very tall aspect ratio)
        if (exif.Width.HasValue && exif.Height.HasValue)
        {
            var aspectRatio = (double)exif.Width.Value / exif.Height.Value;
            if (aspectRatio > 2.5 || aspectRatio < 0.4) // Very wide or very tall
            {
                tags.Add(AssetTagType.Panorama);
            }
        }
        
        // Detect Screenshot (common screen resolutions)
        if (IsScreenshot(exif))
        {
            tags.Add(AssetTagType.Screenshot);
        }
        
        // Detect Live Photo (look for related .mov file)
        if (await IsLivePhotoAsync(filePath, cancellationToken))
        {
            tags.Add(AssetTagType.LivePhoto);
        }
        
        // Detect Burst (multiple files with same base name pattern)
        if (await IsBurstPhotoAsync(filePath, cancellationToken))
        {
            tags.Add(AssetTagType.Burst);
        }
        
        // Detect HDR (specific metadata)
        if (IsHDR(exif))
        {
            tags.Add(AssetTagType.HDR);
        }
        
        return tags;
    }
    
    private bool IsScreenshot(AssetExif exif)
    {
        // Common screenshot resolutions
        var commonScreenshotResolutions = new[]
        {
            (1920, 1080), (2560, 1440), (3840, 2160), // 16:9
            (1080, 1920), (1440, 2560), (2160, 3840), // 9:16 (vertical)
            (2048, 1536), (1024, 768) // 4:3
        };
        
        if (exif.Width.HasValue && exif.Height.HasValue)
        {
            return commonScreenshotResolutions.Contains(
                (exif.Width.Value, exif.Height.Value));
        }
        
        return false;
    }
    
    private async Task<bool> IsLivePhotoAsync(string filePath, CancellationToken cancellationToken)
    {
        // iOS Live Photos: look for .mov file with same base name
        var directory = Path.GetDirectoryName(filePath);
        if (string.IsNullOrEmpty(directory))
            return false;
            
        var fileNameWithoutExt = Path.GetFileNameWithoutExtension(filePath);
        var movPath = Path.Combine(directory, $"{fileNameWithoutExt}.mov");
        
        return await Task.Run(() => File.Exists(movPath), cancellationToken);
    }
    
    private async Task<bool> IsBurstPhotoAsync(string filePath, CancellationToken cancellationToken)
    {
        // Burst photos: files with format "IMG_1234_001.jpg", "IMG_1234_002.jpg", etc.
        var fileName = Path.GetFileNameWithoutExtension(filePath);
        var pattern = @"^(.+)_\d{3,}$";
        
        return await Task.Run(() => 
            System.Text.RegularExpressions.Regex.IsMatch(fileName, pattern), 
            cancellationToken);
    }
    
    private bool IsHDR(AssetExif exif)
    {
        // Look for HDR in keywords or description
        var hdrKeywords = new[] { "HDR", "High Dynamic Range" };
        return exif.Keywords != null && 
               hdrKeywords.Any(k => exif.Keywords.Contains(k, StringComparison.OrdinalIgnoreCase));
    }
    
    /// <summary>
    /// Determines if ML jobs should be triggered for this asset
    /// </summary>
    public bool ShouldTriggerMlJob(Asset asset, AssetExif? exif)
    {
        // Decide based on:
        // - Asset type (only images)
        // - Size (large images)
        // - Should not have pending jobs already
        return asset.Type == AssetType.IMAGE && 
               exif != null &&
               exif.Width.HasValue && 
               exif.Height.HasValue &&
               (exif.Width.Value * exif.Height.Value) > 500000; // > 500K pixels
    }
}
