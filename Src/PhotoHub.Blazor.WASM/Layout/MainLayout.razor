@inherits LayoutComponentBase
@using PhotoHub.Blazor.WASM.Services
@using PhotoHub.Blazor.Shared.Services
@implements IDisposable
@inject NavigationManager Navigation
@inject LayoutService LayoutService
@inject IAuthService AuthService

<MudThemeProvider IsDarkMode="LayoutService.IsDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Dense="false" Color="Color.Surface" Class="@GetAppBarClass()">
        @if (!LayoutService.IsNavbarCustom)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" Class="mr-2" />
            
            <div class="d-flex align-center" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/"))">
                <MudIcon Icon="@Icons.Material.Filled.PhotoCamera" Color="Color.Primary" Size="Size.Large" Class="mr-2" />
                <MudText Typo="Typo.h6" Class="font-weight-bold d-none d-sm-flex">PhotoHub</MudText>
            </div>

            <MudSpacer />

            <div class="search-container d-none d-md-flex">
                <MudTextField @bind-Value="_searchQuery" 
                              Placeholder="Buscar fotos, personas, lugares..." 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense"
                              Class="search-field" />
            </div>

            <MudSpacer />

            <div class="d-flex align-center">
                <MudTooltip Text="Alternar modo claro/oscuro">
                    <MudIconButton Icon="@(LayoutService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                                   Color="Color.Inherit" 
                                   OnClick="@LayoutService.ToggleDarkModeAsync" />
                </MudTooltip>
                <MudTooltip Text="Subir">
                    <MudIconButton Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Inherit" OnClick="@(() => Navigation.NavigateTo("/index"))" />
                </MudTooltip>
                <MudTooltip Text="Configuración">
                    <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" OnClick="@(() => Navigation.NavigateTo("/settings"))" />
                </MudTooltip>
                <AuthorizeView Roles="Admin">
                    <Authorized>
                        <MudTooltip Text="Administración">
                            <MudIconButton Icon="@Icons.Material.Filled.AdminPanelSettings" Color="Color.Inherit" OnClick="@(() => Navigation.NavigateTo("/admin/users"))" />
                        </MudTooltip>
                    </Authorized>
                </AuthorizeView>
                <AuthorizeView>
                    <Authorized>
                        <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                            <MudMenuItem OnClick="Logout">Cerrar Sesión</MudMenuItem>
                        </MudMenu>
                    </Authorized>
                    <NotAuthorized>
                        <MudButton Href="/login" Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small">
                            Iniciar Sesión
                        </MudButton>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        }
        else
        {
            @LayoutService.NavbarContent
        }
    </MudAppBar>
    <style>
        .border-b {
            border-bottom: 1px solid var(--mud-palette-divider);
        }
        .search-container {
            width: 100%;
            max-width: 600px;
        }
        .search-field .mud-input-control {
            margin-top: 0;
        }
        .search-field .mud-input-outlined-border {
            background-color: var(--mud-palette-background-grey);
            border: none;
        }
        .search-field:focus-within .mud-input-outlined-border {
            background-color: var(--mud-palette-surface);
            border: 1px solid var(--mud-palette-primary);
        }
        @* .custom-navbar { *@
        @*     z-index: 1200; *@
        @* } *@
        @* .mud-drawer.mud-drawer-fixed { *@
        @*     z-index: 1350; *@
        @* } *@
        @* .mud-drawer-overlay { *@
        @*     z-index: 1340; *@
        @* } *@
    </style>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="0" 
               Variant="@DrawerVariant.Responsive" Class="@GetDrawerClass()">
        <NavMenu />
    </MudDrawer>
    <style>
        .border-r {
            border-right: 1px solid var(--mud-palette-divider);
        }
        .page-content {
            padding: 24px;
        }
    </style>
    <MudMainContent>
        <div class="page-content" style="min-height: 100%;">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private string _searchQuery = "";

    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#4285f4",
            AppbarBackground = "#ffffff",
            AppbarText = "#202124",
            Background = "#f8f9fa",
            Surface = "#ffffff",
            DrawerBackground = "#ffffff",
            TextPrimary = "#202124",
            TextSecondary = "#5f6368",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#4285f4",
            Surface = "#1a1a1a",
            Background = "#121212",
            BackgroundGray = "#1e1e1e",
            AppbarBackground = "#1a1a1a",
            DrawerBackground = "#1a1a1a",
            TextPrimary = "#e1e1e1",
            TextSecondary = "#aaaaaa",
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "8px",
        }
    };

    private string GetAppBarClass()
    {
        return LayoutService.IsNavbarCustom ? "px-4 custom-navbar" : "px-4 border-b";
    }

    private string GetDrawerClass()
    {
        return LayoutService.IsNavbarCustom ? "d-none" : "border-r";
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        LayoutService.OnMajorUpdate += StateHasChanged;
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        LayoutService.OnMajorUpdate -= StateHasChanged;
    }
}
