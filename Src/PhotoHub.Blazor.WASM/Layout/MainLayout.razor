@inherits LayoutComponentBase
@using PhotoHub.Blazor.WASM.Services
@using PhotoHub.Blazor.Shared.Services
@implements IDisposable
@inject NavigationManager Navigation
@inject LayoutService LayoutService
@inject ThemeService ThemeService
@inject IAuthService AuthService
@inject IDialogService DialogService
@inject ApiErrorNotifier ApiErrorNotifier

<MudThemeProvider IsDarkMode="LayoutService.IsDarkMode" Theme="ThemeService.Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Dense="false" Color="Color.Surface" Class="@GetAppBarClass()">
        @if (!LayoutService.IsNavbarCustom)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" Class="mr-2" />
            
            <div class="d-flex align-center" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/"))">
                <MudIcon Icon="@Icons.Material.Filled.PhotoCamera" Color="Color.Primary" Size="Size.Large" Class="mr-2" />
                <MudText Typo="Typo.h6" Class="font-weight-bold d-none d-sm-flex">PhotoHub</MudText>
            </div>

            <MudSpacer />

            <div class="search-container d-none d-md-flex">
                <MudTextField @bind-Value="_searchQuery"
                              @bind-Value:after="@(() => OnSearchQueryChanged(_searchQuery))"
                              Immediate="true"
                              DebounceInterval="250"
                              Placeholder="Buscar archivos por nombre..." 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense"
                              Class="search-field" />
            </div>

            <MudSpacer />

            <div class="d-flex align-center">
                @if (!IsAdminSection)
                {
                    <MudTooltip Text="Subir">
                        <MudIconButton Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Inherit" OnClick="@(() => Navigation.NavigateTo("/upload"))" />
                    </MudTooltip>
                }
                <MudTooltip Text="Alternar modo claro/oscuro">
                    <MudIconButton Icon="@(LayoutService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                                   Color="Color.Inherit" 
                                   OnClick="@LayoutService.ToggleDarkModeAsync" />
                </MudTooltip>
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />
                    </ActivatorContent>
                    <ChildContent>
                        <div class="d-flex justify-space-between align-center px-4 pt-3">
                            <MudText Typo="Typo.subtitle1">Notificaciones</MudText>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="MarkAllNotificationsRead" Disabled="@(!_notifications.Any())">
                                Marcar todas como leídas
                            </MudButton>
                        </div>
                        <MudDivider Class="my-2" />
                        <MudList T="NotificationItem" Dense="true" Class="px-2 pb-2">
                            @if (_notifications.Any())
                            {
                                @foreach (var notification in _notifications)
                                {
                                    <MudListItem>
                                        <div class="d-flex flex-column">
                                            <MudText Typo="Typo.body2" Class="@(notification.IsRead ? "mud-text-secondary" : "")">
                                                @notification.Message
                                            </MudText>
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                @notification.Timestamp.ToString("dd/MM/yyyy HH:mm")
                                            </MudText>
                                        </div>
                                    </MudListItem>
                                }
                            }
                            else
                            {
                                <MudListItem>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">No hay notificaciones.</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </ChildContent>
                </MudMenu>
                <AuthorizeView>
                    <Authorized>
                        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                            <ActivatorContent>
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="ml-2" Style="width: 32px; height: 32px;">
                                    @UserInitial
                                </MudAvatar>
                            </ActivatorContent>
                            <ChildContent>
                                <div class="d-flex flex-column align-center pa-4" style="min-width: 240px;">
                                    <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Style="width: 56px; height: 56px;">
                                        @UserInitial
                                    </MudAvatar>
                                    <MudText Typo="Typo.subtitle1" Class="mt-2">@UserFullName</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@UserEmail</MudText>
                                </div>
                                <MudDivider />
                                <MudButton Variant="Variant.Text" FullWidth="true" OnClick="@(() => Navigation.NavigateTo("/settings"))">
                                    Configuración cuenta
                                </MudButton>
                                @if (IsAdmin)
                                {
                                    <MudButton Variant="Variant.Text" FullWidth="true" OnClick="@(() => Navigation.NavigateTo("/admin/users"))">
                                        Administración
                                    </MudButton>
                                }
                                <MudDivider />
                                <MudButton Variant="Variant.Text" FullWidth="true" OnClick="Logout">
                                    Cerrar sesión
                                </MudButton>
                            </ChildContent>
                        </MudMenu>
                    </Authorized>
                    <NotAuthorized>
                        <MudButton Href="/login" Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small">
                            Iniciar Sesión
                        </MudButton>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        }
        else
        {
            @LayoutService.NavbarContent
        }
    </MudAppBar>
    <style>
        .border-b {
            border-bottom: 1px solid var(--mud-palette-divider);
        }
        .custom-navbar {
            border-bottom: 1px solid var(--mud-palette-divider);
        }
        .search-container {
            width: 100%;
            max-width: 600px;
        }
        .search-field .mud-input-control {
            margin-top: 0;
        }
        .search-field .mud-input-outlined-border {
            border: none;
        }
        .search-field:focus-within .mud-input-outlined-border {
            border: 1px solid var(--mud-palette-primary);
        }
        @* .custom-navbar { *@
        @*     z-index: 1200; *@
        @* } *@
        @* .mud-drawer.mud-drawer-fixed { *@
        @*     z-index: 1350; *@
        @* } *@
        @* .mud-drawer-overlay { *@
        @*     z-index: 1340; *@
        @* } *@
    </style>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="0" 
               Variant="@DrawerVariant.Responsive" Class="@GetDrawerClass()">
        <NavMenu />
    </MudDrawer>
    <style>
        .border-r {
            border-right: 1px solid var(--mud-palette-divider);
        }
        .page-content {
            padding: 24px;
        }
    </style>
    <MudMainContent Style="flex-grow: 1; display: flex; flex-direction: column;">
        <div class="page-content" style="flex-grow: 1;">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private string _searchQuery = "";

    private string GetAppBarClass()
    {
        return LayoutService.IsNavbarCustom ? "px-4 custom-navbar" : "px-4 border-b";
    }

    private string GetDrawerClass()
    {
        return LayoutService.IsNavbarCustom && !LayoutService.KeepDrawerVisible ? "d-none" : "border-r";
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        LayoutService.OnMajorUpdate += StateHasChanged;
        AuthService.OnAuthStateChanged += HandleAuthStateChanged;
        Navigation.LocationChanged += HandleLocationChanged;
        ApiErrorNotifier.OnError += HandleApiError;
        UpdateSearchQueryFromUri();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserAsync();
    }

    private async void HandleAuthStateChanged()
    {
        await LoadCurrentUserAsync();
        StateHasChanged();
    }

    private async Task LoadCurrentUserAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        LayoutService.OnMajorUpdate -= StateHasChanged;
        AuthService.OnAuthStateChanged -= HandleAuthStateChanged;
        Navigation.LocationChanged -= HandleLocationChanged;
        ApiErrorNotifier.OnError -= HandleApiError;
    }

    private UserDto? _currentUser;
    private readonly List<NotificationItem> _notifications = new()
    {
        new NotificationItem { Message = "Indexación finalizada correctamente.", Timestamp = DateTime.UtcNow.AddMinutes(-12) },
        new NotificationItem { Message = "Se han generado nuevas miniaturas.", Timestamp = DateTime.UtcNow.AddHours(-2) }
    };

    private string UserInitial
        => !string.IsNullOrWhiteSpace(_currentUser?.FirstName)
            ? _currentUser!.FirstName.Trim()[0].ToString().ToUpperInvariant()
            : !string.IsNullOrWhiteSpace(_currentUser?.Username)
                ? _currentUser!.Username.Trim()[0].ToString().ToUpperInvariant()
                : "?";

    private string UserFullName
        => GetUserFullName();

    private string UserEmail => _currentUser?.Email ?? string.Empty;

    private bool IsAdmin => _currentUser?.Role == "Admin";

    private string GetUserFullName()
    {
        var parts = new[] { _currentUser?.FirstName, _currentUser?.LastName }
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .ToArray();

        if (parts.Length > 0)
        {
            return string.Join(" ", parts);
        }

        return _currentUser?.Username ?? "Usuario";
    }

    private bool IsAdminSection
        => new Uri(Navigation.Uri).AbsolutePath.Trim('/').StartsWith("admin", StringComparison.OrdinalIgnoreCase);

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateSearchQueryFromUri();
        StateHasChanged();
    }

    private void HandleApiError(ApiErrorInfo info)
    {
        _ = InvokeAsync(() =>
        {
            var parameters = new DialogParameters
            {
                ["Error"] = info
            };

            var options = new DialogOptions
            {
                Position = DialogPosition.Center,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true,
                BackdropClick = false
            };

            DialogService.Show<ApiErrorDialog>(info.Title, parameters, options);
        });
    }

    private void MarkAllNotificationsRead()
    {
        foreach (var notification in _notifications)
        {
            notification.IsRead = true;
        }
    }

    private void OnSearchQueryChanged(string value)
    {
        _searchQuery = value ?? string.Empty;
        UpdateSearchQueryInUrl(_searchQuery);
    }

    private void UpdateSearchQueryFromUri()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (!uri.AbsolutePath.Equals("/search", StringComparison.OrdinalIgnoreCase))
        {
            if (!string.IsNullOrEmpty(_searchQuery))
            {
                _searchQuery = string.Empty;
            }
            return;
        }

        var queryParams = ParseQuery(uri.Query);
        var newValue = queryParams.TryGetValue("search", out var value) ? value : string.Empty;

        if (!string.Equals(_searchQuery, newValue, StringComparison.Ordinal))
        {
            _searchQuery = newValue;
        }
    }

    private void UpdateSearchQueryInUrl(string value)
    {
        var trimmed = value?.Trim() ?? string.Empty;
        var targetUri = string.IsNullOrWhiteSpace(trimmed)
            ? "/search"
            : $"/search?search={Uri.EscapeDataString(trimmed)}";
        var currentPathAndQuery = Navigation.ToAbsoluteUri(Navigation.Uri).PathAndQuery;

        if (!string.Equals(currentPathAndQuery, targetUri, StringComparison.OrdinalIgnoreCase))
        {
            Navigation.NavigateTo(targetUri, replace: true);
        }
    }

    private static Dictionary<string, string> ParseQuery(string? query)
    {
        var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        if (string.IsNullOrWhiteSpace(query))
        {
            return result;
        }

        var trimmed = query.TrimStart('?');
        var pairs = trimmed.Split('&', StringSplitOptions.RemoveEmptyEntries);

        foreach (var pair in pairs)
        {
            var parts = pair.Split('=', 2);
            var key = Uri.UnescapeDataString(parts[0]);
            if (string.IsNullOrWhiteSpace(key))
            {
                continue;
            }
            var value = parts.Length > 1 ? Uri.UnescapeDataString(parts[1]) : string.Empty;
            result[key] = value;
        }

        return result;
    }

    private sealed class NotificationItem
    {
        public string Message { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public bool IsRead { get; set; }
    }
}
