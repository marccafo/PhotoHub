@page "/admin/stats"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IAdminStatsService AdminStatsService
@inject ISnackbar Snackbar

<PageTitle>Administración - Estadísticas - PhotoHub</PageTitle>

@if (!_isAuthorized)
{
    <div class="mt-8">
        <MudText Typo="Typo.h5">Acceso Denegado</MudText>
        <MudText Typo="Typo.body1">Solo los administradores pueden acceder a esta página.</MudText>
        <MudButton Href="/" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">
            Volver al inicio
        </MudButton>
    </div>
}
else
{
    <div class="mt-4">
        <MudText Typo="Typo.h4" Class="mb-6">Estadísticas del servidor</MudText>

        <MudDivider Class="mb-6" />

        <MudText Typo="Typo.subtitle2" Class="text-uppercase mb-4">Uso total</MudText>
        @if (_loadingStats)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="stats-card pa-6">
                    <div class="d-flex align-center mb-4">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="mr-3">
                            <MudIcon Icon="@Icons.Material.Filled.CameraAlt" />
                        </MudAvatar>
                        <MudText Typo="Typo.h6">Fotos</MudText>
                    </div>
                    <MudText Typo="Typo.h4">@TotalPhotos.ToString("N0")</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="stats-card pa-6">
                    <div class="d-flex align-center mb-4">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="mr-3">
                            <MudIcon Icon="@Icons.Material.Filled.PlayCircle" />
                        </MudAvatar>
                        <MudText Typo="Typo.h6">Vídeos</MudText>
                    </div>
                    <MudText Typo="Typo.h4">@TotalVideos.ToString("N0")</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="stats-card pa-6">
                    <div class="d-flex align-center mb-4">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="mr-3">
                            <MudIcon Icon="@Icons.Material.Filled.Storage" />
                        </MudAvatar>
                        <MudText Typo="Typo.h6">Espacio de almacenamiento</MudText>
                    </div>
                    <MudText Typo="Typo.h4">@TotalStorageGiB.ToString("N0") <span class="stats-unit">GiB</span></MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudText Typo="Typo.subtitle2" Class="text-uppercase mt-8 mb-4">Detalle del uso del usuario</MudText>

        <MudTable Items="@_userUsage" Dense="true" Elevation="0" Hover="true" Class="stats-table">
            <HeaderContent>
                <MudTh>Usuario</MudTh>
                <MudTh>Fotos</MudTh>
                <MudTh>Vídeos</MudTh>
                <MudTh>Uso</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Usuario">@context.DisplayName</MudTd>
                <MudTd DataLabel="Fotos">@context.Photos.ToString("N0") (@FormatGiB(context.PhotoBytes))</MudTd>
                <MudTd DataLabel="Vídeos">@context.Videos.ToString("N0") (@FormatGiB(context.VideoBytes))</MudTd>
                <MudTd DataLabel="Uso">@FormatGiB(context.PhotoBytes + context.VideoBytes) (Sin límites)</MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body2" Class="pa-4">No hay datos de uso.</MudText>
            </NoRecordsContent>
        </MudTable>
    </div>
}

@code {
    private bool _isAuthorized = false;
    private bool _loadingStats = false;
    private AdminStatsResponse? _stats;

    private IReadOnlyList<AdminUserUsage> _userUsage => _stats?.Users ?? new List<AdminUserUsage>();
    private int TotalPhotos => _stats?.TotalPhotos ?? 0;
    private int TotalVideos => _stats?.TotalVideos ?? 0;
    private long TotalStorageGiB => BytesToGiB(_stats?.TotalBytes ?? 0);

    protected override async Task OnInitializedAsync()
    {
        if (!await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var currentUser = await AuthService.GetCurrentUserAsync();
        _isAuthorized = currentUser?.Role == "Admin";

        if (_isAuthorized)
        {
            try
            {
                _loadingStats = true;
                _stats = await AdminStatsService.GetStatsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"No se pudieron cargar las estadísticas: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loadingStats = false;
            }
        }
    }

    private static long BytesToGiB(long bytes)
    {
        if (bytes <= 0)
        {
            return 0;
        }

        return (long)Math.Round(bytes / 1024d / 1024d / 1024d, 0);
    }

    private static string FormatGiB(long bytes)
    {
        var gib = BytesToGiB(bytes);
        return $"{gib:N0} GiB";
    }
}

<style>
    .stats-card {
        border-radius: 16px;
        background: var(--mud-palette-surface);
    }
    .stats-card .mud-avatar {
        width: 40px;
        height: 40px;
    }
    .stats-unit {
        font-size: 0.9rem;
        color: var(--mud-palette-text-secondary);
        margin-left: 6px;
    }
    .stats-table .mud-table-container {
        border-radius: 12px;
        background: var(--mud-palette-surface);
    }
</style>
