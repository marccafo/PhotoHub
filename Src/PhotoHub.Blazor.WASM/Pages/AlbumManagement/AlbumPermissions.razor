@page "/albums/{albumId:guid}/permissions"
@using PhotoHub.Blazor.Shared.Services
@using MudBlazor
@inject IAlbumPermissionService AlbumPermissionService
@inject IUserService UserService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IAuthService AuthService

<PageTitle>Permisos del Álbum - PhotoHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudButton Variant="Variant.Text" 
               StartIcon="@Icons.Material.Filled.ArrowBack" 
               OnClick="@(() => Navigation.NavigateTo($"/albums/{AlbumId}"))"
               Class="mb-4">
        Volver al álbum
    </MudButton>
    
    <MudText Typo="Typo.h4" Class="mb-4">Gestión de Permisos del Álbum</MudText>
    
    @if (!_isAuthorized)
    {
        <MudAlert Severity="Severity.Warning">
            No tienes permisos para gestionar los permisos de este álbum.
        </MudAlert>
    }
    else
    {
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.PersonAdd" 
                   OnClick="OpenAddPermissionDialog"
                   Class="mb-4">
            Compartir con Usuario
        </MudButton>
        
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }
        
        <MudTable Items="@_permissions" Hover="true" Striped="true" Dense="true" Loading="@_loading" Class="mt-4">
            <HeaderContent>
                <MudTh>Usuario</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Ver</MudTh>
                <MudTh>Editar</MudTh>
                <MudTh>Eliminar álbum</MudTh>
                <MudTh>Gestionar Permisos</MudTh>
                <MudTh>Fecha</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Usuario">@context.Username</MudTd>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Ver">
                    <MudIcon Icon="@(context.CanView ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" 
                            Color="@(context.CanView ? Color.Success : Color.Error)" />
                </MudTd>
                <MudTd DataLabel="Editar">
                    <MudIcon Icon="@(context.CanEdit ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" 
                            Color="@(context.CanEdit ? Color.Success : Color.Error)" />
                </MudTd>
                <MudTd DataLabel="Eliminar">
                    <MudIcon Icon="@(context.CanDelete ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" 
                            Color="@(context.CanDelete ? Color.Success : Color.Error)" />
                </MudTd>
                <MudTd DataLabel="Gestionar Permisos">
                    <MudIcon Icon="@(context.CanManagePermissions ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" 
                            Color="@(context.CanManagePermissions ? Color.Success : Color.Error)" />
                </MudTd>
                <MudTd DataLabel="Fecha">@context.GrantedAt.ToString("dd/MM/yyyy")</MudTd>
                <MudTd DataLabel="Acciones">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   OnClick="@(() => OpenEditPermissionDialog(context))" 
                                   Color="Color.Primary"
                                   Size="Size.Small" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   OnClick="@(() => RemovePermission(context.UserId))" 
                                   Color="Color.Error"
                                   Size="Size.Small" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    [Parameter] public Guid AlbumId { get; set; }
    
    private List<AlbumPermissionDto> _permissions = new();
    private bool _loading = true;
    private bool _isAuthorized = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadPermissions();
    }

    private async Task LoadPermissions()
    {
        try
        {
            _loading = true;
            _permissions = await AlbumPermissionService.GetAlbumPermissionsAsync(AlbumId);
            _isAuthorized = true; // Si puede obtener permisos, está autorizado
        }
        catch (UnauthorizedAccessException)
        {
            Snackbar.Add("No tienes permisos suficientes para gestionar este álbum.", Severity.Error);
            _isAuthorized = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar permisos: {ex.Message}", Severity.Error);
            _isAuthorized = false;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenAddPermissionDialog()
    {
        var users = await UserService.GetUsersAsync();
        var currentUser = await AuthService.GetCurrentUserAsync();
        
        // Filtrar usuarios que no sean el actual y que no tengan ya permisos
        var availableUsers = users
            .Where(u => u.Id != currentUser?.Id && !_permissions.Any(p => p.UserId == u.Id))
            .ToList();

        var parameters = new DialogParameters
        {
            ["Users"] = availableUsers,
            ["Permission"] = (AlbumPermissionDto?)null,
            ["IsEdit"] = false,
            ["AlbumId"] = AlbumId
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AlbumPermissionDialog>("Compartir Álbum", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadPermissions();
            Snackbar.Add("Álbum compartido exitosamente", Severity.Success);
        }
    }

    private async Task OpenEditPermissionDialog(AlbumPermissionDto permission)
    {
        var users = await UserService.GetUsersAsync();
        
        var parameters = new DialogParameters
        {
            ["Users"] = users,
            ["Permission"] = permission,
            ["IsEdit"] = true,
            ["AlbumId"] = AlbumId
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AlbumPermissionDialog>("Editar Permisos", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadPermissions();
            Snackbar.Add("Permisos actualizados exitosamente", Severity.Success);
        }
    }

    private async Task RemovePermission(Guid userId)
    {
        var permission = _permissions.FirstOrDefault(p => p.UserId == userId);
        if (permission == null) return;

        bool? result = await DialogService.ShowMessageBox(
            "Confirmar eliminación",
            $"¿Está seguro de que desea revocar los permisos de '{permission.Username}'?",
            yesText: "Eliminar",
            cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await AlbumPermissionService.DeleteAlbumPermissionAsync(AlbumId, userId);
                Snackbar.Add("Permisos revocados exitosamente", Severity.Success);
                await LoadPermissions();
            }
            catch (UnauthorizedAccessException)
            {
                Snackbar.Add("No tienes permisos suficientes para gestionar este álbum.", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al revocar permisos: {ex.Message}", Severity.Error);
            }
        }
    }
}
