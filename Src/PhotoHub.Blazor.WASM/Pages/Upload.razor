@page "/upload"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IAssetService AssetService
@inject ISnackbar Snackbar

<PageTitle>Subir Archivos - PhotoHub</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Subir Assets</MudText>

<MudGrid>
    <MudItem xs="12">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Subir Archivos</MudText>
                    <MudText Typo="Typo.body2">Sube imágenes directamente al almacenamiento de la aplicación.</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudFileUpload T="IReadOnlyList<IBrowserFile>" OnFilesChanged="UploadFiles" Multiple>
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload">
                            Seleccionar Archivos
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>

                @if (_uploadingFiles.Any())
                {
                    <MudList T="string" Class="mt-4">
                        @foreach (var file in _uploadingFiles)
                        {
                            <MudListItem Icon="@(file.Value ? Icons.Material.Filled.Check : Icons.Material.Filled.HourglassEmpty)" 
                                         IconColor="@(file.Value ? Color.Success : Color.Default)">
                                @file.Key
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private Dictionary<string, bool> _uploadingFiles = new();

    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();
        foreach (var file in files)
        {
            _uploadingFiles[file.Name] = false;
        }
        StateHasChanged();

        foreach (var file in files)
        {
            try
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 100); // 100MB max
                var response = await AssetService.UploadAssetAsync(file.Name, stream);
                if (response != null)
                {
                    _uploadingFiles[file.Name] = true;
                    Snackbar.Add($"Archivo {file.Name} subido correctamente", Severity.Success);
                }
                else
                {
                    Snackbar.Add($"Error al subir {file.Name}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error con {file.Name}: {ex.Message}", Severity.Error);
            }
            StateHasChanged();
        }
    }
}
