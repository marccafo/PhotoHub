@page "/register"
@layout LoginLayout
@using PhotoHub.Blazor.Shared.Services
@using MudBlazor
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject PhotoHub.Blazor.Shared.Services.IAuthService AuthService

<PageTitle>Registro - PhotoHub</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <MudContainer MaxWidth="MaxWidth.Small">
        <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">
            Crear Cuenta
        </MudText>
        
        <MudForm @ref="_form" @bind-IsValid="@_isValid" @bind-Errors="@_errors">
            <MudTextField @bind-Value="_username" 
                         Label="Nombre de usuario" 
                         Required="true"
                         RequiredError="El nombre de usuario es obligatorio"
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-3" />
            
            <MudTextField @bind-Value="_email" 
                         Label="Email" 
                         Required="true"
                         RequiredError="El email es obligatorio"
                         Variant="Variant.Outlined"
                         InputType="InputType.Email"
                         FullWidth="true"
                         Class="mb-3" />
            
            <MudTextField @bind-Value="_password" 
                         Label="Contraseña" 
                         InputType="InputType.Password"
                         Required="true"
                         RequiredError="La contraseña es obligatoria"
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-3"
                         HelperText="Mínimo 8 caracteres, debe incluir mayúsculas, minúsculas, números y caracteres especiales" />
            
            <MudTextField @bind-Value="_confirmPassword" 
                         Label="Confirmar contraseña" 
                         InputType="InputType.Password"
                         Required="true"
                         RequiredError="La confirmación es obligatoria"
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-3" />
            
            <MudTextField @bind-Value="_firstName" 
                         Label="Nombre (opcional)" 
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-3" />
            
            <MudTextField @bind-Value="_lastName" 
                         Label="Apellidos (opcional)" 
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-3" />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      FullWidth="true"
                      OnClick="HandleRegister"
                      Disabled="@(!_isValid || _registering || _password != _confirmPassword)"
                      Class="mt-4">
                @if (_registering)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Registrarse
            </MudButton>
        </MudForm>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
            ¿Ya tienes cuenta? 
            <MudLink Href="/login" Typo="Typo.body2">Inicia sesión aquí</MudLink>
        </MudText>
        </MudPaper>
    </MudContainer>
</div>

@code {
    private MudForm? _form;
    private bool _isValid;
    private string[] _errors = Array.Empty<string>();
    private bool _registering = false;
    
    private string _username = string.Empty;
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _confirmPassword = string.Empty;
    private string? _firstName;
    private string? _lastName;

    private async Task HandleRegister()
    {
        await _form!.Validate();
        if (!_isValid) return;

        if (_password != _confirmPassword)
        {
            Snackbar.Add("Las contraseñas no coinciden", Severity.Error);
            return;
        }

        try
        {
            _registering = true;
            var request = new RegisterRequest
            {
                Username = _username,
                Email = _email,
                Password = _password,
                FirstName = _firstName,
                LastName = _lastName
            };

            var response = await HttpClient.PostAsJsonAsync("/api/auth/register", request);
            
            if (response.IsSuccessStatusCode)
            {
                var loginResponse = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (loginResponse != null)
                {
                    var authService = (PhotoHub.Blazor.WASM.Services.AuthService)AuthService;
                    await authService.SaveTokenAsync(loginResponse.Token);
                    await authService.SaveUserAsync(loginResponse.User);
                    Snackbar.Add("Registro exitoso. Bienvenido!", Severity.Success);
                    Navigation.NavigateTo("/");
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                try
                {
                    var errorObj = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(errorContent);
                    var errorMessage = errorObj.TryGetProperty("error", out var errorProp) 
                        ? errorProp.GetString() 
                        : "Error al registrarse";
                    Snackbar.Add(errorMessage ?? "Error al registrarse", Severity.Error);
                }
                catch
                {
                    Snackbar.Add($"Error al registrarse: {errorContent}", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al registrarse: {ex.Message}", Severity.Error);
        }
        finally
        {
            _registering = false;
        }
    }
}
