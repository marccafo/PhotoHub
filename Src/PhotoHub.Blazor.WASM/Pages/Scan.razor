@page "/scan"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IScanService ScanService
@inject IAssetService AssetService
@inject ISnackbar Snackbar
@inject ISettingsService SettingsService

<PageTitle>Escanear - PhotoHub</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Escanear Assets</MudText>

<MudGrid>
    <MudItem xs="12">
        <MudCard Height="100%">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Escanear Directorio Local</MudText>
                    <MudText Typo="Typo.body2">Analiza una carpeta existente en el servidor.</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTextField @bind-Value="_directoryPath" 
                              Label="Ruta del Directorio" 
                              HelperText="Ingresa la ruta completa del directorio a escanear"
                              Variant="Variant.Outlined"
                              FullWidth="true"
                              Class="mb-4" />
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Secondary" 
                           OnClick="StartScan"
                           Disabled="@_scanning"
                           StartIcon="@Icons.Material.Filled.PlayArrow">
                    @if (_scanning)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ml-2" />
                    }
                    Iniciar Escaneo
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@if (_scanning || _lastUpdate != null)
{
    <MudCard Class="mt-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Estado del Escaneo</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                @if (_scanning)
                {
                    <MudChip T="string" Color="Color.Info" Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Autorenew">En curso</MudChip>
                }
                else if (_lastUpdate?.IsCompleted == true)
                {
                    <MudChip T="string" Color="Color.Success" Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Check">Completado</MudChip>
                }
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.body1" Class="mb-2">@_currentStatus</MudText>
            <MudProgressLinear Color="Color.Primary" Value="@_progress" Class="my-4" />
            
            @if (_statistics != null)
            {
                <MudGrid Class="mt-4">
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="1" Padding="4" Class="text-center pa-4">
                            <MudText Typo="Typo.h4" Color="Color.Primary">@_statistics.TotalFilesFound</MudText>
                            <MudText Typo="Typo.body2">Archivos Encontrados</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="1" Padding="4" Class="text-center pa-4">
                            <MudText Typo="Typo.h4" Color="Color.Success">@_statistics.NewFiles</MudText>
                            <MudText Typo="Typo.body2">Nuevos Archivos</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="1" Padding="4" Class="text-center pa-4">
                            <MudText Typo="Typo.h4" Color="Color.Info">@_statistics.UpdatedFiles</MudText>
                            <MudText Typo="Typo.body2">Archivos Actualizados</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="1" Padding="4" Class="text-center pa-4">
                            <MudText Typo="Typo.h4" Color="Color.Warning">@(_statistics.ThumbnailsGenerated + _statistics.ThumbnailsRegenerated)</MudText>
                            <MudText Typo="Typo.body2">Miniaturas</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }

            <MudExpansionPanels Class="mt-4">
                <MudExpansionPanel Text="Registro detallado">
                    <div style="max-height: 200px; overflow-y: auto;">
                        @foreach (var update in _updates.AsEnumerable().Reverse())
                        {
                            <MudText Typo="Typo.caption" Class="d-block border-b pa-1">
                                <span class="text-muted">[@DateTime.Now.ToString("HH:mm:ss")]</span> @update.Message
                            </MudText>
                        }
                    </div>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudCardContent>
    </MudCard>
}

@code {
    private string _directoryPath = "";
    private bool _scanning = false;
    private double _progress = 0;
    private string _currentStatus = "Esperando inicio...";
    private ScanStatistics? _statistics;
    private ScanProgressUpdate? _lastUpdate;
    private List<ScanProgressUpdate> _updates = new();

    protected override async Task OnInitializedAsync()
    {
        _directoryPath = await SettingsService.GetAssetsPathAsync();
    }

    private async Task StartScan()
    {
        if (string.IsNullOrWhiteSpace(_directoryPath))
        {
            Snackbar.Add("Por favor ingresa una ruta de directorio", Severity.Warning);
            return;
        }

        try
        {
            _scanning = true;
            _updates.Clear();
            _progress = 0;
            _statistics = null;
            _lastUpdate = null;
            
            using var cts = new CancellationTokenSource();
            
            await foreach (var update in ScanService.ScanDirectoryAsync(_directoryPath, cts.Token))
            {
                _lastUpdate = update;
                _currentStatus = update.Message;
                _progress = update.Percentage;
                if (update.Statistics != null)
                {
                    _statistics = update.Statistics;
                }
                _updates.Add(update);
                StateHasChanged();
            }
            
            if (_lastUpdate?.IsCompleted == true)
            {
                Snackbar.Add("Escaneo completado exitosamente", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            _currentStatus = $"Error: {ex.Message}";
            Snackbar.Add($"Error durante el escaneo: {ex.Message}", Severity.Error);
        }
        finally
        {
            _scanning = false;
        }
    }
}
