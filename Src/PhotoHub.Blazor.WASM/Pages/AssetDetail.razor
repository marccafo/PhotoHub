@page "/asset/{AssetId:int}"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IAssetService AssetService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Detalle - PhotoHub</PageTitle>

@if (_loading && _asset == null)
{
    <div class="asset-detail-container">
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    </div>
}
else if (_asset != null)
{
    <div class="asset-detail-container" @onkeydown="HandleKeyDown" tabindex="0">
        <style>
            .asset-detail-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #000;
                z-index: 1200;
                display: flex;
                flex-direction: column;
                outline: none;
            }
            .asset-detail-toolbar {
                height: 64px;
                padding: 0 16px;
                display: flex;
                align-items: center;
                background: linear-gradient(rgba(0,0,0,0.7), transparent);
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                transition: opacity 0.3s ease;
                color: white;
            }
            .asset-detail-toolbar.hidden {
                opacity: 0;
                pointer-events: none;
            }
            .asset-detail-content {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                position: relative;
            }
            .asset-detail-image {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                user-select: none;
            }
            .asset-info-drawer {
                width: 360px;
                background-color: #1a1a1a;
                height: 100%;
                overflow-y: auto;
                transition: transform 0.3s ease;
                position: absolute;
                right: 0;
                top: 0;
                z-index: 40;
                border-left: 1px solid #333;
                color: #e1e1e1;
            }
            .asset-info-drawer.closed {
                transform: translateX(100%);
            }
            .nav-button {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: 20;
                background-color: rgba(0,0,0,0.3);
                color: white;
                transition: opacity 0.3s ease, background-color 0.2s;
            }
            .nav-button:hover {
                background-color: rgba(0,0,0,0.6);
            }
            .nav-button.prev { left: 16px; }
            .nav-button.next { right: 16px; }
            .nav-button.hidden {
                opacity: 0;
                pointer-events: none;
            }
        </style>

        <div class="asset-detail-toolbar @(_toolbarVisible ? "" : "hidden")" @onclick:stopPropagation="true">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" OnClick="GoBack" />
            <MudSpacer />
            
            <div class="d-flex align-center gap-1" @onclick:stopPropagation="true">
                <MudTooltip Text="Compartir">
                    <MudIconButton Icon="@Icons.Material.Outlined.Share" Color="Color.Inherit" />
                </MudTooltip>
                
                <MudTooltip Text="Acercar">
                    <MudIconButton Icon="@Icons.Material.Outlined.ZoomIn" Color="Color.Inherit" />
                </MudTooltip>
                
                <MudTooltip Text="Copiar">
                    <MudIconButton Icon="@Icons.Material.Outlined.ContentCopy" Color="Color.Inherit" />
                </MudTooltip>

                <MudTooltip Text="Información">
                    <MudIconButton Icon="@(_infoOpen ? Icons.Material.Filled.Info : Icons.Material.Outlined.Info)" 
                                   Color="Color.Inherit" OnClick="ToggleInfo" />
                </MudTooltip>
                
                <MudTooltip Text="Favorito">
                    <MudToggleIconButton ToggledIcon="@Icons.Material.Filled.Favorite" 
                                         Icon="@Icons.Material.Outlined.FavoriteBorder" 
                                         Color="Color.Inherit" ToggledColor="Color.Error" />
                </MudTooltip>

                <MudTooltip Text="Descargar">
                    <MudIconButton Icon="@Icons.Material.Outlined.Download" Color="Color.Inherit" />
                </MudTooltip>

                <MudTooltip Text="Eliminar">
                    <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Inherit" />
                </MudTooltip>

                <MudMenu Icon="@Icons.Material.Outlined.MoreVert" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <MudMenuItem Icon="@Icons.Material.Outlined.Edit">Editar fecha y hora</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Outlined.LocationOn">Editar ubicación</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Outlined.Add">Añadir a álbum</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Outlined.Archive">Archivar</MudMenuItem>
                </MudMenu>
            </div>
        </div>

        <div class="asset-detail-content" @onclick="ToggleToolbar">
            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                           Class="@GetNavButtonClass(true)" 
                           Size="Size.Large"
                           OnClick="NavigatePrev"
                           OnClickStopPropagation="true"
                           Disabled="@(_prevId == null)" />

            @if (_asset.HasThumbnails)
            {
                <img src="@_asset.ThumbnailUrl" alt="@_asset.FileName" class="asset-detail-image" />
            }
            else
            {
                <MudIcon Icon="@GetAssetIcon(_asset.Type)" Size="Size.Large" Color="Color.Default" Style="width: 128px; height: 128px;" />
            }

            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                           Class="@GetNavButtonClass(false)" 
                           Size="Size.Large"
                           OnClick="NavigateNext"
                           OnClickStopPropagation="true"
                           Disabled="@(_nextId == null)" />
        </div>

        <div class="asset-info-drawer @(_infoOpen ? "" : "closed")">
            <div class="pa-4">
                <div class="d-flex align-center mb-4">
                    <MudText Typo="Typo.h6">Información</MudText>
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Inherit" OnClick="ToggleInfo" />
                </div>

                <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-1">Detalles del archivo</MudText>
                <MudList T="string" Dense="true" ReadOnly="true">
                    <MudListItem Icon="@Icons.Material.Filled.InsertDriveFile" IconColor="Color.Info">
                        <MudText Typo="Typo.body2">@_asset.FileName</MudText>
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.CalendarToday" IconColor="Color.Info">
                        <MudText Typo="Typo.body2">@_asset.DisplayDate</MudText>
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.SdStorage" IconColor="Color.Info">
                        <MudText Typo="Typo.body2">@_asset.FileSizeFormatted</MudText>
                    </MudListItem>
                    @if (!string.IsNullOrEmpty(_asset.FolderPath))
                    {
                        <MudListItem Icon="@Icons.Material.Filled.Folder" IconColor="Color.Info">
                            <MudText Typo="Typo.body2">@_asset.FolderPath</MudText>
                        </MudListItem>
                    }
                </MudList>

                @if (_asset.Exif != null)
                {
                    <MudDivider Class="my-4" Style="background-color: #333;" />
                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-1">EXIF</MudText>
                    <MudList T="string" Dense="true" ReadOnly="true">
                        @if (_asset.Exif.CameraMake != null)
                        {
                            <MudListItem Icon="@Icons.Material.Filled.Camera" IconColor="Color.Info">
                                <MudText Typo="Typo.body2">@_asset.Exif.CameraMake @_asset.Exif.CameraModel</MudText>
                            </MudListItem>
                        }
                        @if (_asset.Exif.Width.HasValue)
                        {
                            <MudListItem Icon="@Icons.Material.Filled.AspectRatio" IconColor="Color.Info">
                                <MudText Typo="Typo.body2">@_asset.Exif.Width x @_asset.Exif.Height</MudText>
                            </MudListItem>
                        }
                    </MudList>
                }

                @if (_asset.Tags.Any())
                {
                    <MudDivider Class="my-4" Style="background-color: #333;" />
                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-2">Etiquetas</MudText>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var tag in _asset.Tags)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary">@tag</MudChip>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <MudAlert Severity="Severity.Error" Class="mt-4">No se pudo cargar la información del archivo.</MudAlert>
    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary" OnClick="GoBack" Class="mt-2">Volver al Timeline</MudButton>
}

@code {
    [Parameter] public int AssetId { get; set; }
    
    private PhotoHub.Blazor.Shared.Models.AssetDetail? _asset;
    private bool _loading = true;
    private bool _infoOpen = false;
    private bool _toolbarVisible = true;
    
    private int? _prevId;
    private int? _nextId;
    private List<int> _allIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsset();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsset();
    }

    private async Task LoadAsset()
    {
        try
        {
            _loading = true;
            _asset = await AssetService.GetAssetDetailAsync(AssetId);
            
            if (_allIds.Count == 0)
            {
                var timeline = await AssetService.GetTimelineAsync();
                _allIds = timeline.Select(a => a.Id).ToList();
            }
            
            UpdateNavigation();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar archivo: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void UpdateNavigation()
    {
        var currentIndex = _allIds.IndexOf(AssetId);
        if (currentIndex != -1)
        {
            _prevId = currentIndex > 0 ? _allIds[currentIndex - 1] : null;
            _nextId = currentIndex < _allIds.Count - 1 ? _allIds[currentIndex + 1] : null;
        }
    }

    private void NavigatePrev()
    {
        if (_prevId.HasValue)
            Navigation.NavigateTo($"/asset/{_prevId.Value}");
    }

    private void NavigateNext()
    {
        if (_nextId.HasValue)
            Navigation.NavigateTo($"/asset/{_nextId.Value}");
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "ArrowLeft") NavigatePrev();
        else if (e.Key == "ArrowRight") NavigateNext();
        else if (e.Key == "Escape") GoBack();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void ToggleInfo()
    {
        _infoOpen = !_infoOpen;
    }

    private void ToggleToolbar()
    {
        _toolbarVisible = !_toolbarVisible;
    }

    private string GetAssetIcon(string type)
    {
        return type == "IMAGE" ? Icons.Material.Filled.Image : Icons.Material.Filled.VideoLibrary;
    }

    private string GetNavButtonClass(bool isPrev)
    {
        var baseClass = isPrev ? "nav-button prev" : "nav-button next";
        var hasId = isPrev ? _prevId != null : _nextId != null;
        return _toolbarVisible && hasId ? baseClass : $"{baseClass} hidden";
    }
}
