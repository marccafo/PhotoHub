@page "/explorer"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IFolderService FolderService
@inject IAssetService AssetService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Explorador - PhotoHub</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Explorador</MudText>

<MudGrid>
    <MudItem xs="12" md="3">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-3">Carpetas</MudText>
                @if (_loadingFolders)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                }
                else
                {
                    <MudTreeView T="FolderItem" Items="@_treeData" SelectedValueChanged="OnFolderSelected" Hover="true" Dense="true">
                        <ItemTemplate>
                            <MudTreeViewItem @bind-Expanded="@context.Expanded" Items="@context.Children" Value="@context.Value" Icon="@context.Icon" Text="@context.Text" />
                        </ItemTemplate>
                    </MudTreeView>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" md="9">
        @if (_selectedFolder != null)
        {
            <MudBreadcrumbs Items="@_breadcrumbs" />
        }
        
        @if (_loadingAssets)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        
        @if (_assets.Any())
        {
            <MudGrid Class="mt-4">
                @foreach (var asset in _assets)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                        <AssetCard Asset="@asset" OnAssetClick="OpenAsset" />
                    </MudItem>
                }
            </MudGrid>
        }
        else if (!_loadingAssets && _selectedFolder != null)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Esta carpeta no contiene archivos.</MudAlert>
        }
        else if (!_loadingAssets)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Selecciona una carpeta para ver sus archivos.</MudAlert>
        }
    </MudItem>
</MudGrid>

@code {
    private List<FolderItem> _folderTree = new();
    private List<TreeItemData<FolderItem>> _treeData = new();
    private FolderItem? _selectedFolder;
    private List<TimelineItem> _assets = new();
    private bool _loadingFolders = true;
    private bool _loadingAssets = false;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadFolders();
    }

    private async Task LoadFolders()
    {
        try
        {
            _loadingFolders = true;
            _folderTree = await FolderService.GetFolderTreeAsync();
            _treeData = MapToTreeItemData(_folderTree);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar carpetas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingFolders = false;
        }
    }

    private List<TreeItemData<FolderItem>> MapToTreeItemData(List<FolderItem> folders)
    {
        return folders.Select(f => new TreeItemData<FolderItem>
        {
            Value = f,
            Text = $"{f.Name} ({f.AssetCount})",
            Icon = Icons.Material.Filled.Folder,
            Children = f.SubFolders.Any() ? MapToTreeItemData(f.SubFolders) : null
        }).ToList();
    }

    private async Task OnFolderSelected(FolderItem folder)
    {
        if (folder == null) return;
        _selectedFolder = folder;
        await LoadFolderAssets(folder.Id);
        UpdateBreadcrumbs(folder);
    }

    private async Task OnFolderClick(FolderItem folder)
    {
        await OnFolderSelected(folder);
    }

    private async Task LoadFolderAssets(int folderId)
    {
        try
        {
            _loadingAssets = true;
            _assets = await FolderService.GetFolderAssetsAsync(folderId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar archivos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingAssets = false;
        }
    }

    private void UpdateBreadcrumbs(FolderItem folder)
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Inicio", "/explorer")
        };

        if (!string.IsNullOrEmpty(folder.Path))
        {
            var parts = folder.Path.Split(new[] { '/', '\\' }, StringSplitOptions.RemoveEmptyEntries);
            foreach (var part in parts)
            {
                _breadcrumbs.Add(new BreadcrumbItem(part, null, disabled: true));
            }
        }
        else
        {
            _breadcrumbs.Add(new BreadcrumbItem(folder.Name, null, disabled: true));
        }
    }

    private void OpenAsset(TimelineItem asset)
    {
        Navigation.NavigateTo($"/asset/{asset.Id}");
    }
}
