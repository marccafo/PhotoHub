@page "/trash"
@using PhotoHub.Blazor.Shared.Models
@using PhotoHub.Blazor.WASM.Services
@inject IFolderService FolderService
@inject IAssetService AssetService
@inject LayoutService LayoutService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Papelera - PhotoHub</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Papelera</MudText>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}

<div class="trash-toolbar">
    <div class="d-flex align-center">
    </div>
    <MudSpacer />
    <MudButton Variant="Variant.Text" Disabled="@(!_assets.Any())" OnClick="OpenRestoreAllDialog">
        Restaurar todo
    </MudButton>
    <MudButton Variant="Variant.Text" Color="Color.Error" Disabled="@(!_assets.Any())" OnClick="OpenEmptyTrashDialog">
        Vaciar papelera
    </MudButton>
</div>

<div class="timeline-wrapper">
    <div class="timeline-main-container">
        <div class="timeline-content-wrapper">
            <div class="timeline-container" id="timeline-scroll-container">
                <div class="timeline-content">
                    @if (_groupedAssets.Any())
                    {
                        @foreach (var group in _groupedAssets)
                        {
                            var dayDate = DateTime.ParseExact(group.Key, "yyyy-MM-dd", null);
                            <div class="day-group" id="@GetGroupId(group.Key)">
                                <MudText Typo="Typo.h6" Class="day-header">@FormatDayHeader(dayDate)</MudText>
                                <div class="masonry-grid" data-day-group="@GetGroupId(group.Key)">
                                    @foreach (var asset in group.Value)
                                    {
                                        <div class="masonry-item"
                                             data-aspect-ratio="@asset.AspectRatio.ToString("F4", System.Globalization.CultureInfo.InvariantCulture)"
                                             data-width="@(asset.Width?.ToString() ?? "0")"
                                             data-height="@(asset.Height?.ToString() ?? "0")">
                                            <div class="asset-select-container @(_selectionMode ? "selection-mode" : "") @(IsAssetSelected(asset.Id) ? "selected" : "")">
                                                <AssetCard Asset="@asset" OnAssetClick="OpenAsset" />
                                                <div class="asset-select-checkbox" @onclick:stopPropagation="true">
                                                    <MudCheckBox T="bool"
                                                                 Value="@IsAssetSelected(asset.Id)"
                                                                 ValueChanged="@(EventCallback.Factory.Create<bool>(this, value => ToggleAssetSelection(asset.Id, value)))" />
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else if (!_loading)
                    {
                        <MudAlert Severity="Severity.Info">La papelera está vacía.</MudAlert>
                    }
                </div>
            </div>
        </div>
        <div class="timeline-sidebar">
        </div>
    </div>

    @if (_groupedAssets.Any())
    {
        <div class="timeline-nav-wrapper">
            <div id="timeline-nav-container" class="vertical-timeline-nav">
                @{
                    var renderedYears = new HashSet<string>();
                }
                @foreach (var group in _groupedAssets)
                {
                    var groupKey = group.Key;
                    var year = GetYearFromGroup(groupKey);

                    if (!renderedYears.Contains(year))
                    {
                        renderedYears.Add(year);
                        var pos = GetGroupPosition(groupKey);
                        var posStr = pos.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);
                        <div class="timeline-nav-item @(IsActiveYear(year) ? "active" : "")"
                             style="top: @($"{posStr}%");"
                             @onclick="@(() => ScrollToGroup(groupKey))">
                            <span class="timeline-nav-label">@year</span>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

<MudDialog @bind-Visible="_purgeSelectedDialogVisible" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Eliminar permanentemente</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>¿Quieres eliminar permanentemente los elementos seleccionados?</MudText>
        <MudText Typo="Typo.caption" Class="mud-text-secondary">Esta acción no se puede deshacer.</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="ClosePurgeSelectedDialog">Cancelar</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" Disabled="@(!_selectedAssetIds.Any())" OnClick="PurgeSelectedAsync">Eliminar</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_restoreAllDialogVisible" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Restaurar todo</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>¿Quieres restaurar todos los elementos de la papelera?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseRestoreAllDialog">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="RestoreAllAsync">Restaurar</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_emptyTrashDialogVisible" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Vaciar papelera</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>¿Quieres eliminar permanentemente todos los elementos de la papelera?</MudText>
        <MudText Typo="Typo.caption" Class="mud-text-secondary">Esta acción no se puede deshacer.</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEmptyTrashDialog">Cancelar</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="EmptyTrashAsync">Vaciar</MudButton>
    </DialogActions>
</MudDialog>

<style>
    :global(body.timeline-page) {
        overflow: hidden !important;
        height: 100vh !important;
    }

    :global(body.timeline-page html) {
        overflow: hidden !important;
        height: 100vh !important;
    }

    :global(body.timeline-page .mud-layout) {
        overflow: hidden !important;
        height: 100vh !important;
    }

    :global(body.timeline-page .mud-main-content) {
        overflow: hidden !important;
        height: 100vh !important;
        position: relative !important;
    }

    .trash-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 4px;
        border-bottom: 1px solid var(--mud-palette-divider);
        margin-bottom: 8px;
    }

    .asset-select-container {
        position: relative;
        height: 100%;
    }

    .asset-select-checkbox {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        opacity: 0;
        transition: opacity 0.2s;
        background: rgba(0,0,0,0.4);
        border-radius: 999px;
        padding: 2px;
    }

    .asset-select-container:hover .asset-select-checkbox {
        opacity: 1;
    }

    .asset-select-container.selection-mode .asset-select-checkbox,
    .asset-select-container.selected .asset-select-checkbox {
        opacity: 1;
    }

    .timeline-wrapper {
        position: relative;
        width: 100%;
        height: calc(100vh - 64px - 48px);
    }

    .timeline-main-container {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
    }

    .timeline-content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .timeline-container {
        display: flex;
        position: relative;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-gutter: stable;
    }

    .timeline-container::-webkit-scrollbar {
        width: 8px;
    }

    .timeline-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .timeline-container::-webkit-scrollbar-thumb {
        background-color: var(--mud-palette-primary);
        border-radius: 4px;
    }

    .timeline-container::-webkit-scrollbar-thumb:hover {
        background-color: var(--mud-palette-primary-lighten);
    }

    .timeline-container {
        scrollbar-width: thin;
        scrollbar-color: var(--mud-palette-primary) transparent;
    }

    .timeline-content {
        flex: 1;
        padding-right: 24px;
        padding-bottom: 200px;
    }

    .timeline-sidebar {
        display: none;
    }

    .day-group {
        margin-bottom: 48px;
    }

    .day-header {
        margin-bottom: 16px !important;
        margin-left: 4px;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
        text-transform: capitalize;
    }

    .masonry-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        width: 100%;
        align-items: flex-start;
        justify-content: flex-start;
        align-content: flex-start;
    }

    .masonry-item {
        height: 180px;
        flex-shrink: 0;
        break-inside: avoid;
        page-break-inside: avoid;
    }

    @@media (min-width: 600px) {
        .masonry-item {
            height: 200px;
        }
    }

    @@media (min-width: 960px) {
        .masonry-item {
            height: 220px;
        }
    }

    @@media (min-width: 1280px) {
        .masonry-item {
            height: 240px;
        }
    }

    @@media (min-width: 1920px) {
        .masonry-item {
            height: 260px;
        }
    }

    .masonry-item .asset-card-container {
        width: 100%;
        height: 100%;
        border-radius: 0 !important;
    }

    .masonry-item img,
    .masonry-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .vertical-timeline-nav {
        position: absolute;
        top: 80px;
        right: 8px;
        bottom: 80px;
        width: 80px;
        pointer-events: none;
    }

    .timeline-nav-item {
        position: absolute;
        left: 0;
        transform: translateY(-50%);
        pointer-events: auto;
        cursor: pointer;
        padding: 4px;
        transition: all 0.2s ease;
    }

    .timeline-nav-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--mud-palette-text-secondary);
        background-color: var(--mud-palette-surface);
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid var(--mud-palette-divider);
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .timeline-nav-item.active .timeline-nav-label {
        color: var(--mud-palette-primary);
        border-color: var(--mud-palette-primary);
        font-size: 0.85rem;
        z-index: 10;
    }
</style>

@code {
    private List<TimelineItem> _assets = new();
    private Dictionary<string, List<TimelineItem>> _groupedAssets = new();
    private bool _loading = true;
    private string _activeGroup = "";
    private DotNetObjectReference<Trash>? _objRef;
    private bool _selectionMode = false;
    private HashSet<Guid> _selectedAssetIds = new();
    private bool _purgeSelectedDialogVisible = false;
    private bool _restoreAllDialogVisible = false;
    private bool _emptyTrashDialogVisible = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTrashAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("scrollHelpers.enableTimelineScroll");

            if (_groupedAssets.Any())
            {
                await SetupScrollListener();
                if (_objRef != null)
                {
                    await Task.Delay(100);
                    await JS.InvokeVoidAsync("scrollHelpers.updateScrollProgress", _objRef);
                }

                await Task.Delay(200);
                await JS.InvokeVoidAsync("masonryHelpers.initializeMasonry");
            }
        }
        else if (_groupedAssets.Any())
        {
            await Task.Delay(200);
            await JS.InvokeVoidAsync("masonryHelpers.initializeMasonry");
        }
    }

    private async Task LoadTrashAsync()
    {
        try
        {
            _loading = true;
            var folders = await FolderService.GetFoldersAsync();
            var trashFolder = folders.FirstOrDefault(folder => IsBinPath(folder.Path));
            if (trashFolder == null)
            {
                _assets = new List<TimelineItem>();
                _groupedAssets = new Dictionary<string, List<TimelineItem>>();
                return;
            }

            var trashRootPath = NormalizePath(trashFolder.Path);
            var trashFolderIds = folders
                .Where(folder => NormalizePath(folder.Path).StartsWith($"{trashRootPath}/", StringComparison.OrdinalIgnoreCase))
                .Select(folder => folder.Id)
                .Distinct()
                .ToList();

            trashFolderIds.Insert(0, trashFolder.Id);

            var assetLists = await Task.WhenAll(trashFolderIds.Select(FolderService.GetFolderAssetsAsync));
            _assets = assetLists.SelectMany(list => list).ToList();
            GroupAssets();
            if (_groupedAssets.Any())
            {
                _activeGroup = _groupedAssets.Keys.First();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar la papelera: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void GroupAssets()
    {
        _groupedAssets = _assets
            .OrderByDescending(GetDeletedDate)
            .GroupBy(asset => GetDeletedDate(asset).Date)
            .ToDictionary(g => g.Key.ToString("yyyy-MM-dd"), g => g.OrderByDescending(GetDeletedDate).ToList());
    }

    private static DateTime GetDeletedDate(TimelineItem asset)
    {
        return asset.DeletedAt ?? asset.ModifiedDate;
    }

    private string FormatDayHeader(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);

        if (date.Date == today)
            return "Hoy";
        if (date.Date == yesterday)
            return "Ayer";
        if (date.Year == today.Year)
            return date.ToString("dddd, d 'de' MMMM", new System.Globalization.CultureInfo("es-ES"));
        return date.ToString("dddd, d 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"));
    }

    private void OpenAsset(TimelineItem asset)
    {
        if (_selectionMode)
        {
            ToggleAssetSelection(asset.Id, !IsAssetSelected(asset.Id));
            return;
        }

        if (asset.SyncStatus == AssetSyncStatus.Synced)
        {
            Navigation.NavigateTo($"/asset/{asset.Id}");
        }
        else
        {
            var encodedPath = System.Net.WebUtility.UrlEncode(asset.FullPath);
            Navigation.NavigateTo($"/asset/{Guid.Empty}?path={encodedPath}");
        }
    }

    private string GetGroupId(string groupName) => "group-" + groupName.Replace(" ", "-").ToLower();

    private async Task SetupScrollListener()
    {
        if (_objRef == null)
        {
            _objRef = DotNetObjectReference.Create(this);
        }
        var groupIds = _groupedAssets.Keys.Select(GetGroupId).ToList();
        await JS.InvokeVoidAsync("scrollHelpers.onWindowScroll", _objRef, groupIds);
    }

    [JSInvokable]
    public void OnScrollUpdated(string activeGroupId, double percentage, double handleTopPixels)
    {
        var groupName = _groupedAssets.Keys.FirstOrDefault(k => GetGroupId(k) == activeGroupId);
        if (!string.IsNullOrEmpty(groupName))
        {
            _activeGroup = groupName;
        }
    }

    private double GetGroupPosition(string groupName)
    {
        if (!_groupedAssets.Any()) return 0;
        var keys = _groupedAssets.Keys.ToList();
        var index = keys.IndexOf(groupName);
        if (index == -1) return 0;
        return (double)index / (keys.Count - 1) * 100;
    }

    private bool IsActiveYear(string year)
    {
        if (string.IsNullOrEmpty(_activeGroup)) return false;
        return GetYearFromGroup(_activeGroup) == year;
    }

    private string GetYearFromGroup(string groupKey)
    {
        if (DateTime.TryParseExact(groupKey, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out var date))
        {
            return date.Year.ToString();
        }
        return "";
    }

    private async Task ScrollToGroup(string groupName)
    {
        _activeGroup = groupName;
        await JS.InvokeVoidAsync("scrollHelpers.scrollToElement", GetGroupId(groupName));
    }

    private static bool IsBinPath(string path)
    {
        return path.Replace('\\', '/').EndsWith("/_trash", StringComparison.OrdinalIgnoreCase);
    }

    private static string NormalizePath(string path)
    {
        return path.Replace('\\', '/').TrimEnd('/');
    }


    private void ExitSelectionMode()
    {
        _selectionMode = false;
        _selectedAssetIds.Clear();
        UpdateSelectionNavbar();
    }

    private void ToggleAssetSelection(Guid assetId, bool selected)
    {
        if (!_selectionMode)
        {
            _selectionMode = true;
        }

        if (selected)
        {
            _selectedAssetIds.Add(assetId);
        }
        else
        {
            _selectedAssetIds.Remove(assetId);
            if (_selectedAssetIds.Count == 0)
            {
                ExitSelectionMode();
                return;
            }
        }
        UpdateSelectionNavbar();
    }

    private bool IsAssetSelected(Guid assetId) => _selectedAssetIds.Contains(assetId);

    private void ToggleSelectAll()
    {
        if (_selectedAssetIds.Count == _assets.Count && _assets.Any())
        {
            _selectedAssetIds.Clear();
            UpdateSelectionNavbar();
            return;
        }

        _selectedAssetIds = _assets.Select(asset => asset.Id).ToHashSet();
        UpdateSelectionNavbar();
    }

    private void ExitSelectionFromNavbar()
    {
        ExitSelectionMode();
    }

    private void UpdateSelectionNavbar()
    {
        if (!_selectionMode)
        {
            LayoutService.ResetNavbar();
            return;
        }

        var selectedCount = _selectedAssetIds.Count;
        var allSelected = _assets.Any() && selectedCount == _assets.Count;

        LayoutService.SetCustomNavbar(
            @<text>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" Edge="Edge.Start" OnClick="ExitSelectionFromNavbar" />
                <MudText Typo="Typo.h6" Class="ml-2">@($"{selectedCount} seleccionadas")</MudText>
                <MudSpacer />
                <MudTooltip Text="@(allSelected ? "Deseleccionar todo" : "Seleccionar todo")">
                    <MudIconButton Icon="@Icons.Material.Filled.SelectAll" Color="Color.Inherit" Disabled="@(!_assets.Any())" OnClick="ToggleSelectAll" />
                </MudTooltip>
                <MudTooltip Text="Restaurar">
                    <MudIconButton Icon="@Icons.Material.Filled.Restore" Color="Color.Inherit" Disabled="@(!_selectedAssetIds.Any())" OnClick="RestoreSelectedAsync" />
                </MudTooltip>
                <MudTooltip Text="Eliminar permanentemente">
                    <MudIconButton Icon="@Icons.Material.Filled.DeleteForever" Color="Color.Inherit" Disabled="@(!_selectedAssetIds.Any())" OnClick="OpenPurgeSelectedDialog" />
                </MudTooltip>
            </text>
        , keepDrawerVisible: true);
    }

    private async Task RestoreSelectedAsync()
    {
        if (!_selectedAssetIds.Any())
        {
            return;
        }

        try
        {
            await AssetService.RestoreAssetsAsync(new RestoreAssetsRequest
            {
                AssetIds = _selectedAssetIds.ToList()
            });

            ExitSelectionMode();
            await LoadTrashAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al restaurar archivos: {ex.Message}", Severity.Error);
        }
    }

    private void OpenPurgeSelectedDialog()
    {
        _purgeSelectedDialogVisible = true;
    }

    private void ClosePurgeSelectedDialog()
    {
        _purgeSelectedDialogVisible = false;
    }

    private async Task PurgeSelectedAsync()
    {
        if (!_selectedAssetIds.Any())
        {
            return;
        }

        try
        {
            await AssetService.PurgeAssetsAsync(new PurgeAssetsRequest
            {
                AssetIds = _selectedAssetIds.ToList()
            });

            _purgeSelectedDialogVisible = false;
            ExitSelectionMode();
            await LoadTrashAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar archivos: {ex.Message}", Severity.Error);
        }
    }

    private void OpenRestoreAllDialog()
    {
        _restoreAllDialogVisible = true;
    }

    private void CloseRestoreAllDialog()
    {
        _restoreAllDialogVisible = false;
    }

    private async Task RestoreAllAsync()
    {
        try
        {
            await AssetService.RestoreTrashAsync();
            _restoreAllDialogVisible = false;
            ExitSelectionMode();
            await LoadTrashAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al restaurar la papelera: {ex.Message}", Severity.Error);
        }
    }

    private void OpenEmptyTrashDialog()
    {
        _emptyTrashDialogVisible = true;
    }

    private void CloseEmptyTrashDialog()
    {
        _emptyTrashDialogVisible = false;
    }

    private async Task EmptyTrashAsync()
    {
        try
        {
            await AssetService.EmptyTrashAsync();
            _emptyTrashDialogVisible = false;
            ExitSelectionMode();
            await LoadTrashAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al vaciar la papelera: {ex.Message}", Severity.Error);
        }
    }

    public void Dispose()
    {
        _objRef?.Dispose();
        JS.InvokeVoidAsync("scrollHelpers.disableTimelineScroll");
        LayoutService.ResetNavbar();
    }
}
