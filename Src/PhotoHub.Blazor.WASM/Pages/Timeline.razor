@page "/"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IAssetService AssetService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Timeline - PhotoHub</PageTitle>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}

<div class="timeline-wrapper">
    <div class="timeline-main-container">
        <div class="timeline-content-wrapper">

            <div class="timeline-container" id="timeline-scroll-container">
                <div class="timeline-content">
                    @if (_groupedAssets.Any())
                    {
                        @foreach (var group in _groupedAssets)
                        {
                            var dayDate = DateTime.ParseExact(group.Key, "yyyy-MM-dd", null);
                            <div class="day-group" id="@GetGroupId(group.Key)">
                                <MudText Typo="Typo.h6" Class="day-header">@FormatDayHeader(dayDate)</MudText>
                                <div class="masonry-grid" data-day-group="@GetGroupId(group.Key)">
                                    @foreach (var asset in group.Value)
                                    {
                                        <div class="masonry-item" 
                                             data-aspect-ratio="@asset.AspectRatio.ToString("F4", System.Globalization.CultureInfo.InvariantCulture)"
                                             data-width="@(asset.Width?.ToString() ?? "0")"
                                             data-height="@(asset.Height?.ToString() ?? "0")">
                                            <AssetCard Asset="@asset" OnAssetClick="OpenAsset" />
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else if (!_loading)
                    {
                        <MudAlert Severity="Severity.Info">No hay fotografías disponibles. Indexa un directorio para comenzar.</MudAlert>
                    }
                </div>
            </div>
        </div>
        
        <div class="timeline-sidebar">
        </div>
    </div>
    
    @if (_groupedAssets.Any())
    {
        <div class="timeline-nav-wrapper">
    <div id="timeline-nav-container" class="vertical-timeline-nav">
        @{
            var renderedYears = new HashSet<string>();
        }
        @foreach (var group in _groupedAssets)
        {
            var groupKey = group.Key;
            var year = GetYearFromGroup(groupKey);

            @if (!renderedYears.Contains(year))
            {
                renderedYears.Add(year);
                var pos = GetGroupPosition(groupKey);
                var posStr = pos.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);
                <div class="timeline-nav-item @(IsActiveYear(year) ? "active" : "")" 
                     style="top: @($"{posStr}%");"
                     @onclick="@(() => ScrollToGroup(groupKey))">
                    <span class="timeline-nav-label">@year</span>
                </div>
            }
        }
    </div>
        </div>
    }
</div>

<style>
    /* Desactivar scroll en body/html y contenedores de MudBlazor */
    :global(body.timeline-page) {
        overflow: hidden !important;
        height: 100vh !important;
    }

    :global(body.timeline-page html) {
        overflow: hidden !important;
        height: 100vh !important;
    }

    :global(body.timeline-page .mud-layout) {
        overflow: hidden !important;
        height: 100vh !important;
    }

    :global(body.timeline-page .mud-main-content) {
        overflow: hidden !important;
        height: 100vh !important;
        position: relative !important;
    }

    /* Contenedor principal del timeline */
    .timeline-wrapper {
        position: relative;
        width: 100%;
        height: calc(100vh - 64px - 48px);
    }

    /* Contenedor principal con flex para layout horizontal */
    .timeline-main-container {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
    }

    /* Contenedor del contenido principal */
    .timeline-content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Contenedor del timeline es el único con scroll */
    .timeline-container {
        display: flex;
        position: relative;
        width: 100%;
        height: 100%;
        overflow-y: auto; 
        overflow-x: hidden;
        scrollbar-gutter: stable;
    }

    /* Estilo del scrollbar nativo */
    .timeline-container::-webkit-scrollbar {
        width: 8px; 
    }

    .timeline-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .timeline-container::-webkit-scrollbar-thumb {
        background-color: var(--mud-palette-primary);
        border-radius: 4px;
    }

    .timeline-container::-webkit-scrollbar-thumb:hover {
        background-color: var(--mud-palette-primary-lighten);
    }

    /* Firefox */
    .timeline-container {
        scrollbar-width: thin;
        scrollbar-color: var(--mud-palette-primary) transparent;
    }

    .timeline-content {
        flex: 1;
        padding-right: 24px; 
        padding-bottom: 200px;
    }

    /* Sidebar con barra de scroll */
    .timeline-sidebar {
        display: none; 
    }

    /* Estilos para agrupación por día */
    .day-group {
        margin-bottom: 48px;
    }

    .day-header {
        margin-bottom: 16px !important;
        margin-left: 4px;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
        text-transform: capitalize;
    }

    /* Layout tipo masonry justificado - llena todo el ancho */
    .masonry-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        width: 100%;
        align-items: flex-start;
        justify-content: flex-start;
        align-content: flex-start;
    }

    .masonry-item {
        height: 180px;
        flex-shrink: 0;
        break-inside: avoid;
        page-break-inside: avoid;
    }

    @@media (min-width: 600px) {
        .masonry-item {
            height: 200px;
        }
    }

    @@media (min-width: 960px) {
        .masonry-item {
            height: 220px;
        }
    }

    @@media (min-width: 1280px) {
        .masonry-item {
            height: 240px;
        }
    }

    @@media (min-width: 1920px) {
        .masonry-item {
            height: 260px;
        }
    }

    .masonry-item .asset-card-container {
        width: 100%;
        height: 100%;
        border-radius: 0 !important;
    }

    .masonry-item img,
    .masonry-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .timeline-nav-wrapper {
        position: absolute;
        right: 8px;
        top: 0;
        bottom: 0;
        width: 40px;
        z-index: 100;
        pointer-events: none;
        display: flex;
        flex-direction: column;
    }

    .vertical-timeline-nav {
        position: relative;
        height: 100%;
        width: 100%;
    }

    .timeline-nav-item {
        position: absolute;
        left: 0;
        transform: translateY(-50%);
        pointer-events: auto;
        cursor: pointer;
        padding: 4px;
        transition: all 0.2s ease;
    }

    .timeline-nav-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--mud-palette-text-secondary);
        background-color: var(--mud-palette-surface);
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid var(--mud-palette-divider);
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .timeline-nav-item.active .timeline-nav-label {
        color: var(--mud-palette-primary);
        border-color: var(--mud-palette-primary);
        font-size: 0.85rem;
        z-index: 10;
    }
</style>

@code {
    private List<TimelineItem> _assets = new();
    private Dictionary<string, List<TimelineItem>> _groupedAssets = new();
    private bool _loading = true;
    private string _activeGroup = "";
    private DotNetObjectReference<Timeline>? _objRef;
    

    protected override async Task OnInitializedAsync()
    {
        await LoadTimeline();
    }
    
    private string? GetDateFromQuery()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (string.IsNullOrEmpty(uri.Query))
            return null;
            
        var query = uri.Query.TrimStart('?');
        var pairs = query.Split('&');
        
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=', 2);
            if (parts.Length == 2 && parts[0] == "date")
            {
                return Uri.UnescapeDataString(parts[1]);
            }
        }
        
        return null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Agregar clase al body para aplicar estilos específicos de Timeline
            await JS.InvokeVoidAsync("scrollHelpers.enableTimelineScroll");
            
            if (_groupedAssets.Any())
            {
                await SetupScrollListener();
                
                // Inicializar el progreso del scroll después de que el listener esté configurado
                if (_objRef != null)
                {
                    await Task.Delay(100);
                    await JS.InvokeVoidAsync("scrollHelpers.updateScrollProgress", _objRef);
                }
                
                // Inicializar masonry layout después de que los elementos estén renderizados
                await Task.Delay(200);
                await JS.InvokeVoidAsync("masonryHelpers.initializeMasonry");
                
                // Si hay un parámetro de fecha en la query string, hacer scroll a esa fecha
                var dateParam = GetDateFromQuery();
                if (!string.IsNullOrEmpty(dateParam))
                {
                    await ScrollToDate(dateParam);
                }
            }
        }
        else
        {
            // Reinicializar masonry después de actualizaciones
            if (_groupedAssets.Any())
            {
                await Task.Delay(200);
                await JS.InvokeVoidAsync("masonryHelpers.initializeMasonry");
            }
        }
    }
    
    private async Task ScrollToDate(string dateString)
    {
        if (DateTime.TryParse(dateString, out var targetDate))
        {
            // Buscar el grupo que contiene esta fecha (por día)
            var targetGroup = _groupedAssets.Keys.FirstOrDefault(g => 
            {
                var groupDate = GetDayDateFromGroup(g);
                return groupDate.Date == targetDate.Date;
            });
            
            if (!string.IsNullOrEmpty(targetGroup))
            {
                await Task.Delay(500); // Esperar a que el DOM esté completamente renderizado
                await ScrollToGroup(targetGroup);
            }
        }
    }

    private async Task SetupScrollListener()
    {
        if (_objRef == null)
        {
            _objRef = DotNetObjectReference.Create(this);
        }
        var groupIds = _groupedAssets.Keys.Select(GetGroupId).ToList();
        await JS.InvokeVoidAsync("scrollHelpers.onWindowScroll", _objRef, groupIds);
    }

    [JSInvokable]
    public void OnScrollUpdated(string activeGroupId, double percentage, double handleTopPixels)
    {
        var groupName = _groupedAssets.Keys.FirstOrDefault(k => GetGroupId(k) == activeGroupId);
        if (!string.IsNullOrEmpty(groupName))
        {
            _activeGroup = groupName;
        }
        StateHasChanged();
    }

    private double GetGroupPosition(string groupName)
    {
        if (!_groupedAssets.Any()) return 0;
        
        var keys = _groupedAssets.Keys.ToList();
        var index = keys.IndexOf(groupName);
        if (index == -1) return 0;
        
        return (double)index / (keys.Count - 1) * 100;
    }

    private string GetGroupStyle(string groupName)
    {
        return $"top: {GetGroupPosition(groupName).ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}%;";
    }

    private async Task LoadTimeline()
    {
        try
        {
            _loading = true;
            _assets = await AssetService.GetTimelineAsync();
            GroupAssets();
            if (_groupedAssets.Any())
            {
                _activeGroup = _groupedAssets.Keys.First();
                // No llamamos a SetupScrollListener aquí porque necesitamos que el DOM esté listo
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar timeline: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void GroupAssets()
    {
        _groupedAssets = _assets
            .OrderByDescending(a => a.CreatedDate)
            .GroupBy(a => a.CreatedDate.Date)
            .ToDictionary(g => g.Key.ToString("yyyy-MM-dd"), g => g.OrderByDescending(a => a.CreatedDate).ToList());
    }
    
    private string FormatDayHeader(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);
        
        if (date.Date == today)
            return "Hoy";
        else if (date.Date == yesterday)
            return "Ayer";
        else if (date.Year == today.Year)
            return date.ToString("dddd, d 'de' MMMM", new System.Globalization.CultureInfo("es-ES"));
        else
            return date.ToString("dddd, d 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"));
    }

    private void OpenAsset(TimelineItem asset)
    {
        if (asset.SyncStatus == AssetSyncStatus.Synced)
        {
            Navigation.NavigateTo($"/asset/{asset.Id}");
        }
        else
        {
            var encodedPath = System.Net.WebUtility.UrlEncode(asset.FullPath);
            Navigation.NavigateTo($"/asset/0?path={encodedPath}");
        }
    }

    private string GetGroupId(string groupName)
    {
        return "group-" + groupName.Replace(" ", "-").ToLower();
    }
    
    private DateTime GetDayDateFromGroup(string groupKey)
    {
        if (DateTime.TryParseExact(groupKey, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out var date))
        {
            return date;
        }
        return DateTime.MinValue;
    }

    private async Task ScrollToGroup(string groupName)
    {
        // Al hacer scroll manual, actualizamos el estado
        _activeGroup = groupName;
        await JS.InvokeVoidAsync("scrollHelpers.scrollToElement", GetGroupId(groupName));
    }

    private bool IsActiveYear(string year) 
    {
        if (string.IsNullOrEmpty(_activeGroup)) return false;
        return GetYearFromGroup(_activeGroup) == year;
    }

    private bool IsActive(string groupName) => _activeGroup == groupName;

    private string GetYearFromGroup(string groupKey)
    {
        // "2024-01-15" -> "2024"
        var date = GetDayDateFromGroup(groupKey);
        return date != DateTime.MinValue ? date.Year.ToString() : "";
    }

    public void Dispose()
    {
        _objRef?.Dispose();
        // Remover clase del body al salir de la página
        JS.InvokeVoidAsync("scrollHelpers.disableTimelineScroll");
    }
}
