@page "/"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IAssetService AssetService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Timeline - PhotoHub</PageTitle>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}

<div class="timeline-container">
    <div class="timeline-content">
        @if (_groupedAssets.Any())
        {
            @foreach (var group in _groupedAssets)
            {
                <div class="mb-6" id="@GetGroupId(group.Key)">
                    <MudText Typo="Typo.h6" Class="mb-3 font-weight-bold ml-1">@group.Key</MudText>
                    <MudGrid Spacing="1">
                        @foreach (var asset in group.Value)
                        {
                            <MudItem xs="4" sm="3" md="2" lg="2" xl="1">
                                <AssetCard Asset="@asset" OnAssetClick="OpenAsset" />
                            </MudItem>
                        }
                    </MudGrid>
                </div>
            }
        }
        else if (!_loading)
        {
            <MudAlert Severity="Severity.Info">No hay fotograf√≠as disponibles. Escanea un directorio para comenzar.</MudAlert>
        }
    </div>

    @if (_groupedAssets.Any())
    {
        <div class="vertical-timeline-nav">
            @foreach (var group in _groupedAssets)
            {
                <div class="timeline-nav-item @(IsActive(group.Key) ? "active" : "")" 
                     @onclick="@(() => ScrollToGroup(group.Key))">
                    <span class="timeline-nav-label">@GetShortLabel(group.Key)</span>
                    <div class="timeline-nav-dot"></div>
                </div>
            }
        </div>
    }
</div>

<style>
    .timeline-container {
        display: flex;
        position: relative;
    }

    .timeline-content {
        flex: 1;
        padding-right: 60px;
    }

    .vertical-timeline-nav {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        z-index: 100;
        padding: 10px 0;
        user-select: none;
    }

    .timeline-nav-item {
        display: flex;
        align-items: center;
        margin: 4px 0;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0.6;
    }

    .timeline-nav-item:hover, .timeline-nav-item.active {
        opacity: 1;
    }

    .timeline-nav-label {
        font-size: 0.75rem;
        font-weight: 500;
        margin-right: 8px;
        display: none;
        color: var(--mud-palette-text-primary);
    }

    .timeline-nav-item:hover .timeline-nav-label, .timeline-nav-item.active .timeline-nav-label {
        display: block;
    }

    .timeline-nav-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--mud-palette-text-disabled);
        transition: all 0.2s ease;
    }

    .timeline-nav-item.active .timeline-nav-dot {
        background-color: var(--mud-palette-primary);
        transform: scale(1.3);
    }

    .timeline-nav-item:hover .timeline-nav-dot {
        background-color: var(--mud-palette-primary);
    }
</style>

@code {
    private List<TimelineItem> _assets = new();
    private Dictionary<string, List<TimelineItem>> _groupedAssets = new();
    private bool _loading = true;
    private string _activeGroup = "";
    private DotNetObjectReference<Timeline>? _objRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadTimeline();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _groupedAssets.Any())
        {
            await SetupScrollListener();
        }
    }

    private async Task SetupScrollListener()
    {
        _objRef = DotNetObjectReference.Create(this);
        var groupIds = _groupedAssets.Keys.Select(GetGroupId).ToList();
        await JS.InvokeVoidAsync("scrollHelpers.onWindowScroll", _objRef, groupIds);
    }

    [JSInvokable]
    public void OnGroupVisible(string groupId)
    {
        var groupName = _groupedAssets.Keys.FirstOrDefault(k => GetGroupId(k) == groupId);
        if (!string.IsNullOrEmpty(groupName) && _activeGroup != groupName)
        {
            _activeGroup = groupName;
            StateHasChanged();
        }
    }

    private async Task LoadTimeline()
    {
        try
        {
            _loading = true;
            _assets = await AssetService.GetTimelineAsync();
            GroupAssets();
            if (_groupedAssets.Any())
            {
                _activeGroup = _groupedAssets.Keys.First();
                await SetupScrollListener();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar timeline: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void GroupAssets()
    {
        _groupedAssets = _assets
            .OrderByDescending(a => a.CreatedDate)
            .GroupBy(a => a.CreatedDate.ToString("MMMM yyyy", new System.Globalization.CultureInfo("es-ES")))
            .ToDictionary(g => char.ToUpper(g.Key[0]) + g.Key.Substring(1), g => g.ToList());
    }

    private void OpenAsset(TimelineItem asset)
    {
        Navigation.NavigateTo($"/asset/{asset.Id}");
    }

    private string GetGroupId(string groupName)
    {
        return "group-" + groupName.Replace(" ", "-").ToLower();
    }

    private async Task ScrollToGroup(string groupName)
    {
        // Al hacer scroll manual, desactivamos temporalmente el listener de scroll o simplemente actualizamos el estado
        _activeGroup = groupName;
        await JS.InvokeVoidAsync("scrollHelpers.scrollToElement", GetGroupId(groupName));
    }

    private bool IsActive(string groupName) => _activeGroup == groupName;

    private string GetShortLabel(string groupName)
    {
        // "Enero 2024" -> "Ene 2024"
        if (string.IsNullOrEmpty(groupName)) return "";
        var parts = groupName.Split(' ');
        if (parts.Length < 2) return groupName;
        
        var month = parts[0].Length > 3 ? parts[0].Substring(0, 3) : parts[0];
        return $"{char.ToUpper(month[0]) + month.Substring(1)} {parts[1]}";
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }
}
