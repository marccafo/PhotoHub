@page "/"
@using PhotoHub.Blazor.Shared.Services
@using PhotoHub.Blazor.Shared.Models
@using MudBlazor
@inject IAssetService AssetService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Timeline - PhotoHub</PageTitle>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}

<div class="timeline-container">
    <div class="timeline-content">
        @if (_groupedAssets.Any())
        {
            @foreach (var group in _groupedAssets)
            {
                <div class="mb-6" id="@GetGroupId(group.Key)">
                    <MudText Typo="Typo.h6" Class="mb-3 font-weight-bold ml-1">@group.Key</MudText>
                    <MudGrid Spacing="1">
                        @foreach (var asset in group.Value)
                        {
                            <MudItem xs="4" sm="3" md="2" lg="2" xl="1">
                                <AssetCard Asset="@asset" OnAssetClick="OpenAsset" />
                            </MudItem>
                        }
                    </MudGrid>
                </div>
            }
        }
        else if (!_loading)
        {
            <MudAlert Severity="Severity.Info">No hay fotografías disponibles. Escanea un directorio para comenzar.</MudAlert>
        }
    </div>

    @if (_groupedAssets.Any())
    {
        <div class="timeline-nav-wrapper">
            <div id="timeline-nav-container" class="vertical-timeline-nav">
                <div class="timeline-line"></div>
                <div class="timeline-handle" style="@(_handleStyle)">
                    <div class="timeline-handle-marker"></div>
                </div>
                
                @foreach (var group in _groupedAssets)
                {
                    var groupKey = group.Key;
                    <div class="timeline-nav-item @(IsActive(groupKey) ? "active" : "")" 
                         style="@(GetGroupStyle(groupKey))"
                         @onclick="@(() => ScrollToGroup(groupKey))">
                        <span class="timeline-nav-label">@GetShortLabel(groupKey)</span>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    /* Ocultar barra de scroll nativa para esta página */
    :global(body)::-webkit-scrollbar {
        display: none;
    }
    :global(body) {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    .timeline-container {
        display: flex;
        position: relative;
    }

    .timeline-content {
        flex: 1;
        padding-right: 24px;
    }

    .timeline-nav-wrapper {
        position: fixed;
        right: 0;
        top: 64px; /* Debajo del AppBar */
        bottom: 0;
        width: 16px; /* Ancho similar a un scrollbar */
        z-index: 1200; /* Justo debajo del AppBar de MudBlazor (1300) */
        display: flex;
        justify-content: center;
        background-color: transparent;
    }

    .vertical-timeline-nav {
        position: relative;
        height: 100%;
        width: 100%;
        cursor: pointer;
        user-select: none;
    }

    .timeline-line {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--mud-palette-divider);
        transition: width 0.2s, background-color 0.2s;
    }

    .timeline-handle {
        position: absolute;
        right: 0;
        width: 100%;
        height: 40px; /* Tamaño del tirador */
        pointer-events: none;
        transition: top 0.05s linear;
    }

    .timeline-handle-marker {
        position: absolute;
        right: 0;
        top: 0;
        width: 6px;
        height: 100%;
        background-color: var(--mud-palette-primary);
        border-radius: 3px 0 0 3px;
        box-shadow: -1px 0 4px rgba(0,0,0,0.2);
    }

    .timeline-nav-item {
        position: absolute;
        right: 25px;
        display: flex;
        align-items: center;
        transform: translateY(-50%);
        transition: all 0.2s ease;
        opacity: 0;
        pointer-events: none;
    }

    .timeline-nav-item.active {
        opacity: 1;
    }

    .vertical-timeline-nav:hover .timeline-nav-item, 
    .vertical-timeline-nav.dragging .timeline-nav-item {
        opacity: 0.6;
        pointer-events: auto;
    }

    .timeline-nav-item:hover, .timeline-nav-item.active {
        opacity: 1 !important;
    }

    .timeline-nav-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
        white-space: nowrap;
        background-color: var(--mud-palette-surface);
        padding: 4px 10px;
        border-radius: 20px;
        box-shadow: var(--mud-elevation-3);
        border: 1px solid var(--mud-palette-divider);
    }

    /* Estilo durante el arrastre o hover */
    .vertical-timeline-nav:hover .timeline-line,
    .vertical-timeline-nav.dragging .timeline-line {
        width: 12px;
        background-color: var(--mud-palette-primary-hover);
    }
</style>

@code {
    private List<TimelineItem> _assets = new();
    private Dictionary<string, List<TimelineItem>> _groupedAssets = new();
    private bool _loading = true;
    private string _activeGroup = "";
    private double _scrollPercentage = 0;
    private string _handleStyle => $"top: calc({(_scrollPercentage).ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}% - {(_scrollPercentage * 40 / 100).ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}px);";
    private DotNetObjectReference<Timeline>? _objRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadTimeline();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _groupedAssets.Any())
        {
            await SetupScrollListener();
        }
    }

    private async Task SetupScrollListener()
    {
        if (_objRef == null)
        {
            _objRef = DotNetObjectReference.Create(this);
        }
        var groupIds = _groupedAssets.Keys.Select(GetGroupId).ToList();
        await JS.InvokeVoidAsync("scrollHelpers.onWindowScroll", _objRef, groupIds);
        await JS.InvokeVoidAsync("scrollHelpers.initTimelineDrag", _objRef, "timeline-nav-container");
    }

    [JSInvokable]
    public void OnScrollUpdated(string activeGroupId, double percentage)
    {
        _scrollPercentage = percentage;
        var groupName = _groupedAssets.Keys.FirstOrDefault(k => GetGroupId(k) == activeGroupId);
        if (!string.IsNullOrEmpty(groupName))
        {
            _activeGroup = groupName;
        }
        StateHasChanged();
    }

    private double GetGroupPosition(string groupName)
    {
        if (!_groupedAssets.Any()) return 0;
        
        var keys = _groupedAssets.Keys.ToList();
        var index = keys.IndexOf(groupName);
        if (index == -1) return 0;
        
        return (double)index / (keys.Count - 1) * 100;
    }

    private string GetGroupStyle(string groupName)
    {
        return $"top: {GetGroupPosition(groupName).ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}%;";
    }

    private async Task LoadTimeline()
    {
        try
        {
            _loading = true;
            _assets = await AssetService.GetTimelineAsync();
            GroupAssets();
            if (_groupedAssets.Any())
            {
                _activeGroup = _groupedAssets.Keys.First();
                // No llamamos a SetupScrollListener aquí porque necesitamos que el DOM esté listo
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar timeline: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void GroupAssets()
    {
        _groupedAssets = _assets
            .OrderByDescending(a => a.CreatedDate)
            .GroupBy(a => a.CreatedDate.ToString("MMMM yyyy", new System.Globalization.CultureInfo("es-ES")))
            .ToDictionary(g => char.ToUpper(g.Key[0]) + g.Key.Substring(1), g => g.ToList());
    }

    private void OpenAsset(TimelineItem asset)
    {
        Navigation.NavigateTo($"/asset/{asset.Id}");
    }

    private string GetGroupId(string groupName)
    {
        return "group-" + groupName.Replace(" ", "-").ToLower();
    }

    private async Task ScrollToGroup(string groupName)
    {
        // Al hacer scroll manual, desactivamos temporalmente el listener de scroll o simplemente actualizamos el estado
        _activeGroup = groupName;
        await JS.InvokeVoidAsync("scrollHelpers.scrollToElement", GetGroupId(groupName));
    }

    private bool IsActive(string groupName) => _activeGroup == groupName;

    private string GetShortLabel(string groupName)
    {
        // "Enero 2024" -> "Ene 2024"
        if (string.IsNullOrEmpty(groupName)) return "";
        var parts = groupName.Split(' ');
        if (parts.Length < 2) return groupName;
        
        var month = parts[0].Length > 3 ? parts[0].Substring(0, 3) : parts[0];
        return $"{char.ToUpper(month[0]) + month.Substring(1)} {parts[1]}";
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }
}
