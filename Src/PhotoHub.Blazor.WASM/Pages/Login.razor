@page "/login"
@layout LoginLayout
@using PhotoHub.Blazor.Shared.Services
@using MudBlazor
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Iniciar Sesión - PhotoHub</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <MudContainer MaxWidth="MaxWidth.Small">
        <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">
            PhotoHub
        </MudText>
        
        <MudForm @ref="_form" @bind-IsValid="@_isValid" @bind-Errors="@_errors">
            <MudTextField @bind-Value="_username" 
                         Label="Usuario o Email" 
                         Required="true"
                         RequiredError="El usuario o email es obligatorio"
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-4"
                         StartAdornment="@(new RenderFragment(builder => builder.AddContent(0, new MarkupString("<i class=\"mud-icon-root mud-svg-icon mud-icon-size-medium\"><svg class=\"mud-icon-root mud-svg-icon mud-icon-size-medium\" viewBox=\"0 0 24 24\"><path d=\"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\"/></svg></i>"))))" />
            
            <MudTextField @bind-Value="_password" 
                         Label="Contraseña" 
                         InputType="InputType.Password"
                         Required="true"
                         RequiredError="La contraseña es obligatoria"
                         Variant="Variant.Outlined"
                         FullWidth="true"
                         Class="mb-4"
                         StartAdornment="@(new RenderFragment(builder => builder.AddContent(0, new MarkupString("<i class=\"mud-icon-root mud-svg-icon mud-icon-size-medium\"><svg class=\"mud-icon-root mud-svg-icon mud-icon-size-medium\" viewBox=\"0 0 24 24\"><path d=\"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z\"/></svg></i>"))))" />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      FullWidth="true"
                      OnClick="HandleLogin"
                      Disabled="@(!_isValid || _loggingIn)"
                      Class="mt-4">
                @if (_loggingIn)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Iniciar Sesión
            </MudButton>
        </MudForm>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
            ¿No tienes cuenta? 
            <MudLink Href="/register" Typo="Typo.body2">Regístrate aquí</MudLink>
        </MudText>
        </MudPaper>
    </MudContainer>
</div>

@code {
    private MudForm? _form;
    private bool _isValid;
    private string[] _errors = Array.Empty<string>();
    private bool _loggingIn = false;
    
    private string _username = string.Empty;
    private string _password = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Si ya está autenticado, redirigir a la página principal
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        await _form!.Validate();
        if (!_isValid) return;

        try
        {
            _loggingIn = true;
            var success = await AuthService.LoginAsync(_username, _password);
            
            if (success)
            {
                Snackbar.Add("Inicio de sesión exitoso", Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                Snackbar.Add("Usuario o contraseña incorrectos", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al iniciar sesión: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loggingIn = false;
        }
    }
}
